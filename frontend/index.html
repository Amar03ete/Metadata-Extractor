<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetaForensic - Advanced Metadata Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: #000000; 
      color: #e0e0e0; 
      line-height: 1.6;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #666666; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
    
    header { 
      text-align: center; 
      margin-bottom: 40px; 
      padding: 40px 0; 
      border-bottom: 1px solid #2d2d2d;
    }
    h1 { 
      font-size: 2.5em; 
      font-weight: 700; 
      margin-bottom: 10px;
      color: #ffffff;
      letter-spacing: 0.5px;
    }
    .subtitle { 
      color: #999999; 
      font-size: 0.95em; 
      letter-spacing: 0.3px;
      font-weight: 300;
    }

    .backend-status { margin-top: 10px; font-weight: 600; color: #ccaa66; }
    
    .upload-section { 
      background: #1a1a1a; 
      border: 2px dashed #404040; 
      border-radius: 8px; 
      padding: 60px 30px; 
      text-align: center; 
      margin-bottom: 40px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .upload-section:hover { 
      background: #2d2d2d; 
      border-color: #666666;
    }
    .upload-icon { font-size: 3em; margin-bottom: 20px; }
    .upload-text { font-size: 1.3em; margin-bottom: 10px; color: #ffffff; font-weight: 500; }
    .upload-subtext { color: #808080; font-size: 0.9em; }
    
    #fileInput { display: none; }
    .controls { display: flex; gap: 30px; margin-bottom: 30px; justify-content: center; align-items: center; }
    label { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      color: #cccccc; 
      cursor: pointer; 
      font-size: 0.95em;
      user-select: none;
    }
    label:hover { color: #ffffff; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #666666; }
    
    .loader { display: none; text-align: center; padding: 40px; }
    .spinner { 
      border: 3px solid #2d2d2d; 
      border-top: 3px solid #666666; 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite; 
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader-text { color: #cccccc; font-size: 1em; letter-spacing: 0.3px; }
    
    .error-display { 
      display: none; 
      background: #2a1a1a; 
      border: 1px solid #664444; 
      border-radius: 6px; 
      padding: 20px; 
      margin-bottom: 30px;
    }
    .error-display.show { display: block; }
    .error-title { color: #cc6666; font-size: 1.1em; font-weight: 600; margin-bottom: 10px; }
    .error-text { color: #999999; font-size: 0.95em; word-break: break-word; }
    
    .output { display: none; }
    .output.show { display: block; }
    
    .info-card { 
      background: #1a1a1a; 
      border-left: 3px solid #404040; 
      padding: 25px; 
      margin-bottom: 25px; 
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .info-card:hover { 
      background: #242424; 
      border-left-color: #666666;
    }
    .info-card.danger { 
      border-left-color: #664444; 
      background: #1f1515;
    }
    
    .card-title { 
      color: #ffffff; 
      font-size: 1.2em; 
      font-weight: 600; 
      margin-bottom: 20px; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 1em;
    }
    
    .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
    .data-item { 
      background: #0f0f0f; 
      padding: 15px; 
      border-radius: 4px; 
      border: 1px solid #2d2d2d;
    }
    .data-label { 
      color: #808080; 
      font-size: 0.75em; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      margin-bottom: 8px;
      font-weight: 500;
    }
    .data-value { 
      color: #e0e0e0; 
      font-size: 0.95em; 
      word-break: break-all;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }
    
    .forensic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .summary-stat { 
      background: #1a1a1a; 
      padding: 20px; 
      border-radius: 4px; 
      text-align: center; 
      border: 1px solid #2d2d2d;
      transition: all 0.3s ease;
    }
    .summary-stat:hover { 
      background: #242424; 
      border-color: #404040;
    }
    .stat-label { 
      color: #808080; 
      font-size: 0.75em; 
      text-transform: uppercase; 
      margin-bottom: 8px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .stat-value { 
      color: #ffffff; 
      font-size: 1.8em; 
      font-weight: 700;
    }
    .stat-status { color: #999999; font-size: 0.85em; margin-top: 8px; }
    
    .flag-item { 
      background: #0f0f0f; 
      padding: 15px; 
      border-radius: 4px; 
      border-left: 3px solid; 
      margin-bottom: 12px; 
      transition: all 0.3s ease;
    }
    .flag-item.high { border-left-color: #cc6666; }
    .flag-item.medium { border-left-color: #ccaa66; }
    .flag-item.low { border-left-color: #999999; }
    .flag-item:hover { background: #1a1a1a; }
    
    .flag-severity { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 3px; 
      font-size: 0.7em; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.3px; 
      margin-bottom: 8px;
      background: #2d2d2d;
      color: #cccccc;
    }
    .flag-severity.high { background: #664444; color: #ffffff; }
    .flag-severity.medium { background: #664d33; color: #ffffff; }
    .flag-severity.low { background: #404040; color: #ffffff; }
    
    .flag-title { 
      color: #ffffff; 
      font-weight: 600; 
      margin-bottom: 6px; 
      text-transform: uppercase; 
      letter-spacing: 0.3px;
      font-size: 0.95em;
    }
    .flag-message { color: #cccccc; margin-bottom: 8px; font-size: 0.9em; }
    
    pre { 
      background: #0f0f0f; 
      border: 1px solid #2d2d2d; 
      border-radius: 4px; 
      padding: 15px; 
      overflow-x: auto; 
      color: #b0b0b0; 
      font-size: 0.85em; 
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }
    
    button { 
      background: #2d2d2d; 
      border: 1px solid #404040; 
      color: #ffffff; 
      padding: 12px 30px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      transition: all 0.3s ease; 
      font-size: 0.85em;
    }
    button:hover { 
      background: #404040; 
      border-color: #666666;
    }
    button:active { transform: scale(0.98); }
    
    details { 
      background: #1a1a1a; 
      border: 1px solid #2d2d2d; 
      border-radius: 4px; 
      padding: 15px; 
      margin-bottom: 20px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    details:hover { 
      background: #242424; 
      border-color: #404040;
    }
    summary { 
      color: #ffffff; 
      font-weight: 600; 
      font-size: 0.95em; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      outline: none; 
      user-select: none;
    }
    summary:hover { color: #cccccc; }
    
    @media (max-width: 768px) { 
      h1 { font-size: 1.8em; } 
      .data-grid { grid-template-columns: 1fr; } 
      .forensic-summary { grid-template-columns: repeat(2, 1fr); } 
      .container { padding: 20px 15px; }
    }
    /* Disclaimer modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1200; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: #0f0f0f; border: 1px solid #2d2d2d; padding: 22px; width: 720px; max-width: 92%; border-radius: 8px; color: #e0e0e0; }
    .modal h3 { margin-bottom: 10px; color: #ffffff; }
    .modal p { color: #cccccc; margin-bottom: 12px; }
    .modal .modal-actions { text-align: right; margin-top: 12px; display:flex; gap:10px; justify-content:flex-end; }
    .modal .btn-primary { background: #2d2d2d; border: 1px solid #404040; color: #ffffff; padding: 10px 16px; border-radius: 4px; cursor:pointer; }
    .modal .btn-secondary { background: transparent; border: 1px solid #404040; color: #cccccc; padding: 10px 16px; border-radius: 4px; cursor:pointer; }

    /* Footer disclaimer */
    .footer-disclaimer { margin-top: 40px; padding: 18px; background: #0b0b0b; border-top: 1px solid #1f1f1f; color: #cfcfcf; font-size: 0.95em; border-radius: 4px; }
    .footer-disclaimer strong { color: #ffffff; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>MetaForensic</h1>
      <p class="subtitle">Advanced Metadata Analysis & Forensic Intelligence</p>
      <div id="backendStatus" class="backend-status">Backend: unknown</div>
    </header>

    <div class="upload-section" id="dropZone">
      <div class="upload-icon">üìÅ</div>
      <p class="upload-text">Drop files here or click to select</p>
      <p class="upload-subtext">Supported: PDF, DOCX, XLSX, PPTX</p>
    </div>
    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.xlsx,.pptx,.doc,.xls,.ppt">

    <div class="controls">
      <label>
        <input type="checkbox" id="deepScan" checked> Deep Scan
      </label>
      <label>
        <input type="checkbox" id="forensicAnalysis" checked> Forensic Analysis
      </label>
    </div>

    <div id="loader" class="loader">
      <div class="spinner"></div>
      <p class="loader-text">Analyzing files...</p>
    </div>

    <div id="errorDisplay" class="error-display">
      <div class="error-title">Error Detected</div>
      <p id="errorText" class="error-text"></p>
    </div>

    <div id="output" class="output">
      <!-- Forensic Summary -->
      <div class="info-card">
        <div class="card-title">Forensic Summary</div>
        <div class="forensic-summary" id="forensicSummaryContent"></div>
      </div>

      <!-- File Identity -->
      <div class="info-card">
        <div class="card-title">File Identity</div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">Filename</div>
            <div class="data-value" id="filename"></div>
          </div>
          <div class="data-item">
            <div class="data-label">File Type / MIME</div>
            <div class="data-value" id="fileType"></div>
          </div>
          <div class="data-item">
            <div class="data-label">File Size</div>
            <div class="data-value" id="fileSize"></div>
          </div>
        </div>
      </div>

      <!-- File Hashes -->
      <div class="info-card">
        <div class="card-title">File Integrity - Unique Identifiers</div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">MD5 Hash</div>
            <div class="data-value" id="hashMd5" style="font-family: 'Courier New', monospace; font-size: 0.8em;"></div>
          </div>
          <div class="data-item">
            <div class="data-label">SHA-1 Hash</div>
            <div class="data-value" id="hashSha1" style="font-family: 'Courier New', monospace; font-size: 0.8em;"></div>
          </div>
          <div class="data-item">
            <div class="data-label">SHA-256 Hash</div>
            <div class="data-value" id="hashSha256" style="font-family: 'Courier New', monospace; font-size: 0.8em;"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Inode</div>
            <div class="data-value" id="inode"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Hard Links</div>
            <div class="data-value" id="hardLinks"></div>
          </div>
        </div>
      </div>

      <!-- Timestamps with Timezone -->
      <div class="info-card">
        <div class="card-title">Timestamps with Timezone Information</div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">Created Date</div>
            <div class="data-value" id="createdDate"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Modified Date</div>
            <div class="data-value" id="modifiedDate"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Accessed Date</div>
            <div class="data-value" id="accessedDate"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Timezone Name</div>
            <div class="data-value" id="timezoneName"></div>
          </div>
          <div class="data-item">
            <div class="data-label">UTC Offset</div>
            <div class="data-value" id="utcOffset"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Daylight Saving</div>
            <div class="data-value" id="daylightSaving"></div>
          </div>
        </div>
      </div>

      <!-- Storage & Access Permissions -->
      <div class="info-card">
        <div class="card-title">Storage & Access - Permissions & Ownership</div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">File Path</div>
            <div class="data-value" id="filePath"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Permissions</div>
            <div class="data-value" id="permissions"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Owner (UID)</div>
            <div class="data-value" id="owner"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Group (GID)</div>
            <div class="data-value" id="group"></div>
          </div>
        </div>
      </div>

      <!-- OS & Hardware Metadata -->
      <div class="info-card">
        <div class="card-title">OS & Hardware Metadata</div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">Operating System</div>
            <div class="data-value" id="osSystem"></div>
          </div>
          <div class="data-item">
            <div class="data-label">OS Release</div>
            <div class="data-value" id="osRelease"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Architecture</div>
            <div class="data-value" id="osArch"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Hostname</div>
            <div class="data-value" id="hostname"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Processor</div>
            <div class="data-value" id="processor"></div>
          </div>
          <div class="data-item">
            <div class="data-label">CPU Cores (Physical)</div>
            <div class="data-value" id="cpuPhysical"></div>
          </div>
          <div class="data-item">
            <div class="data-label">CPU Cores (Logical)</div>
            <div class="data-value" id="cpuLogical"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Total Memory</div>
            <div class="data-value" id="memoryTotal"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Python Version</div>
            <div class="data-value" id="pythonVersion"></div>
          </div>
        </div>
      </div>

      <!-- Provenance & Authorship -->
      <div class="info-card">
        <div class="card-title">Provenance & Authorship</div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">Document Author</div>
            <div class="data-value" id="docAuthor"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Last Modified By</div>
            <div class="data-value" id="lastModifiedBy"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Creator Software</div>
            <div class="data-value" id="creatorSoftware"></div>
          </div>
          <div class="data-item">
            <div class="data-label">Producer/Company</div>
            <div class="data-value" id="producer"></div>
          </div>
        </div>
      </div>

      <!-- Forensic Flags -->
      <div class="info-card danger">
        <div class="card-title">Forensic Flags & Anomalies</div>
        <div id="forensicFlags"></div>
      </div>

      <!-- Errors Section -->
      <div id="errorsSection" class="info-card danger" style="display:none;">
        <div class="card-title">Error Logs</div>
        <pre id="errorsMeta"></pre>
      </div>

      <!-- Raw Metadata -->
      <details>
        <summary>Full Raw Metadata (JSON)</summary>
        <pre id="rawMeta" style="margin-top: 20px;"></pre>
      </details>

      <div style="text-align: center; margin-top: 40px;">
        <button id="downloadReport">Download Report (JSON)</button>
      </div>
    </div>
    <!-- Disclaimer modal -->
    <div id="disclaimerModal" class="modal-overlay" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <h3>Educational Use Disclaimer</h3>
        <p><strong>Warning:</strong> This tool is provided <em>for educational purposes only</em>. It is intended to demonstrate metadata extraction and forensic analysis techniques in a learning context. Use of this tool for unlawful, commercial, or operational investigations is not permitted by this application. The creators/providers are not liable for any consequences arising from inappropriate use.</p>
        <p>The purpose of this warning is to limit liability, specify the scope of use, and remind users that "fair use" and legal restrictions still apply. For more information, consult applicable laws and licensing terms.</p>
        <div class="modal-actions">
          <button id="disclaimerCancel" class="btn-secondary">Cancel</button>
          <button id="disclaimerContinue" class="btn-primary">I Understand ‚Äî Continue</button>
        </div>
      </div>
    </div>

    <div class="footer-disclaimer">
      <strong>Educational Purposes Only:</strong> This tool is provided solely for learning and research. The authors disclaim liability for misuse. Results are illustrative and should not be used for operational decision-making or legal evidence without proper verification.
    </div>
  </div>

  <script>
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const loader = document.getElementById("loader");
    const output = document.getElementById("output");
    const errorDisplay = document.getElementById("errorDisplay");
    
    let currentAnalysisData = null;

    dropZone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
      if (e.target.files.length > 1) handleMultipleFiles(Array.from(e.target.files));
      else if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    // Backend base (updateable) - use 127.0.0.1 to avoid occasional localhost resolution issues
    // Detect environment: Vercel, localhost, or custom
    let BACKEND_BASE = window.BACKEND_BASE;
    if (!BACKEND_BASE) {
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        BACKEND_BASE = 'http://127.0.0.1:8000';
      } else {
        // Vercel or production: use same domain with /api prefix
        BACKEND_BASE = window.location.origin;
      }
    }

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.style.backgroundColor = "#2d2d2d";
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.style.backgroundColor = "#1a1a1a";
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.style.backgroundColor = "#1a1a1a";
      const files = Array.from(e.dataTransfer.files);
      if (files.length > 1) handleMultipleFiles(files);
      else if (files[0]) handleFile(files[0]);
    });

    async function checkBackend() {
      try {
        const res = await fetch(`${BACKEND_BASE}/api/health`, { method: 'GET' });
        if (!res.ok) throw new Error(`Health check failed: ${res.status} ${res.statusText}`);
        return true;
      } catch (err) {
        throw new Error(`Cannot reach backend at ${BACKEND_BASE}: ${err.message}. Ensure backend is running and CORS allows requests.`);
      }
    }

    // Update backend status indicator in header
    async function updateBackendStatus() {
      const el = document.getElementById('backendStatus');
      try {
        const res = await fetch(`${BACKEND_BASE}/api/health`, { method: 'GET' });
        if (res.ok) {
          el.textContent = 'Backend: healthy';
          el.style.color = '#66cc88';
        } else {
          el.textContent = `Backend: degraded (${res.status})`;
          el.style.color = '#cc6666';
        }
      } catch (err) {
        el.textContent = 'Backend: unreachable';
        el.style.color = '#cc6666';
      }
    }

    // Run once at load and poll every 8 seconds
    updateBackendStatus();
    setInterval(updateBackendStatus, 8000);

    async function handleFile(file) {
      if (!file) return;
      // Preflight backend health check
      try {
        await checkBackend();
      } catch (err) {
        showError(err.message);
        return;
      }

      // Show disclaimer modal before proceeding
      showDisclaimer(async () => {
        loader.style.display = "block";
        output.classList.remove("show");
        errorDisplay.classList.remove("show");

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch(`${BACKEND_BASE}/api/analyze`, {
            method: "POST",
            body: formData
          });

          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || error.error || "Analysis failed");
          }

          const json = await res.json();
          currentAnalysisData = json;
          displayResults(json);
        } catch (error) {
          showError(error.message);
        } finally {
          loader.style.display = "none";
        }
      });
    }

    async function handleMultipleFiles(files) {
      // Preflight backend health check
      try {
        await checkBackend();
      } catch (err) {
        showError(err.message);
        return;
      }

      // Show disclaimer modal before proceeding with multiple files
      showDisclaimer(async () => {
        loader.style.display = "block";
        output.classList.remove("show");
        errorDisplay.classList.remove("show");

        const formData = new FormData();
        files.forEach(file => formData.append("files", file));

        try {
          const res = await fetch(`${BACKEND_BASE}/api/analyze`, {
            method: "POST",
            body: formData
          });

          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || error.error || "Analysis failed");
          }

          const json = await res.json();
          if (json.results && json.results.length > 0) {
            currentAnalysisData = json.results[0];
            displayResults(json.results[0]);
          }
        } catch (error) {
          showError(error.message);
        } finally {
          loader.style.display = "none";
        }
      });
    }

    // Disclaimer modal handling
    const disclaimerModal = document.getElementById('disclaimerModal');
    const disclaimerContinue = document.getElementById('disclaimerContinue');
    const disclaimerCancel = document.getElementById('disclaimerCancel');
    let _disclaimerCallback = null;

    function showDisclaimer(cb) {
      _disclaimerCallback = cb;
      disclaimerModal.classList.add('show');
    }

    disclaimerContinue.addEventListener('click', () => {
      disclaimerModal.classList.remove('show');
      if (_disclaimerCallback) {
        try { _disclaimerCallback(); } catch (e) { console.error(e); }
        _disclaimerCallback = null;
      }
    });

    disclaimerCancel.addEventListener('click', () => {
      disclaimerModal.classList.remove('show');
      _disclaimerCallback = null;
    });

    function formatHashForDisplay(hash) {
      return hash ? hash.substring(0, 16) + "..." : "N/A";
    }

    function displayResults(json) {
      output.classList.add("show");
      errorDisplay.classList.remove("show");

      // File Identity
      document.getElementById("filename").textContent = json.filename || "Unknown";
      document.getElementById("fileType").textContent = json.file_identity?.mime_type || json.file_type || "Unknown";
      document.getElementById("fileSize").textContent = json.file_identity?.file_size || "Unknown";

      // File Hashes
      document.getElementById("hashMd5").textContent = json.file_hashes?.md5 || "N/A";
      document.getElementById("hashSha1").textContent = json.file_hashes?.sha1 || "N/A";
      document.getElementById("hashSha256").textContent = json.file_hashes?.sha256 || "N/A";
      document.getElementById("inode").textContent = json.storage_access?.inode || "N/A";
      document.getElementById("hardLinks").textContent = json.storage_access?.hard_links || "N/A";

      // Timestamps with Timezone
      const timestamps = json.timestamps || {};
      document.getElementById("createdDate").textContent = timestamps.created?.datetime || "N/A";
      document.getElementById("modifiedDate").textContent = timestamps.modified?.datetime || "N/A";
      document.getElementById("accessedDate").textContent = timestamps.accessed?.datetime || "N/A";
      
      const tz = json.timezone_metadata || {};
      document.getElementById("timezoneName").textContent = tz.local_timezone || "N/A";
      document.getElementById("utcOffset").textContent = tz.utc_offset || "N/A";
      document.getElementById("daylightSaving").textContent = tz.is_daylight_saving ? "Yes" : "No";

      // Storage & Access
      const storage = json.storage_access || {};
      document.getElementById("filePath").textContent = storage.file_path || "N/A";
      document.getElementById("permissions").textContent = (storage.permissions || "N/A") + " (" + (storage.permissions_octal || "N/A") + ")";
      document.getElementById("owner").textContent = (storage.owner || "N/A") + " (UID: " + (storage.owner_uid || "N/A") + ")";
      document.getElementById("group").textContent = (storage.group || "N/A") + " (GID: " + (storage.group_gid || "N/A") + ")";

      // OS & Hardware
      const osHw = json.os_hardware_metadata || {};
      document.getElementById("osSystem").textContent = osHw.os_system || "N/A";
      document.getElementById("osRelease").textContent = osHw.os_release || "N/A";
      document.getElementById("osArch").textContent = osHw.os_machine || "N/A";
      document.getElementById("hostname").textContent = osHw.hostname || "N/A";
      document.getElementById("processor").textContent = osHw.processor || "N/A";
      document.getElementById("cpuPhysical").textContent = osHw.cpu_count_physical || "N/A";
      document.getElementById("cpuLogical").textContent = osHw.cpu_count_logical || "N/A";
      document.getElementById("memoryTotal").textContent = osHw.memory_total || "N/A";
      document.getElementById("pythonVersion").textContent = osHw.python_version || "N/A";

      // Provenance & Authorship
      const auth = json.provenance_authorship || {};
      const author = auth.docx_author || auth.xlsx_author || auth.pptx_author || auth.pdf_author || "N/A";
      const modified = auth.docx_last_modified_by || auth.xlsx_last_modified_by || auth.pptx_last_modified_by || "N/A";
      const creator = auth.pdf_creator || auth.docx_author || "N/A";
      const producer = auth.pdf_producer || "N/A";
      
      document.getElementById("docAuthor").textContent = author;
      document.getElementById("lastModifiedBy").textContent = modified;
      document.getElementById("creatorSoftware").textContent = creator;
      document.getElementById("producer").textContent = producer;

      const forensicSummary = json.forensic_flags?.summary || {};
      const riskScore = json.forensic_flags?.risk_score || 0;
      const totalFlags = json.forensic_flags?.total_flags || 0;
      
      const statusColors = {
        clean: "#cccccc",
        suspicious: "#ccaa66",
        dangerous: "#cc6666"
      };
      
      document.getElementById("forensicSummaryContent").innerHTML = `
        <div class="summary-stat">
          <div class="stat-label">Status</div>
          <div class="stat-value" style="color: ${statusColors[forensicSummary.status] || statusColors.clean}">
            ${forensicSummary.status?.toUpperCase() || "UNKNOWN"}
          </div>
        </div>
        <div class="summary-stat">
          <div class="stat-label">Risk Score</div>
          <div class="stat-value" style="color: ${riskScore >= 5 ? "#cc6666" : riskScore >= 2 ? "#ccaa66" : "#cccccc"}">
            ${riskScore}/10
          </div>
        </div>
        <div class="summary-stat">
          <div class="stat-label">Flags Detected</div>
          <div class="stat-value">${totalFlags}</div>
          <div class="stat-status">${forensicSummary.message || "Analysis complete"}</div>
        </div>
      `;

      const flagsContainer = document.getElementById("forensicFlags");
      if (json.forensic_flags?.flags && json.forensic_flags.flags.length > 0) {
        flagsContainer.innerHTML = json.forensic_flags.flags.map(flag => {
          const severity = flag.severity || "low";
          return `
            <div class="flag-item ${severity}">
              <span class="flag-severity ${severity}">${severity}</span>
              <div class="flag-title">${flag.flag || "Unknown Flag"}</div>
              <div class="flag-message">${flag.message || "No message"}</div>
              ${flag.details ? `<pre style="margin-top: 10px; opacity: 0.7; font-size: 0.85em;">${JSON.stringify(flag.details, null, 2)}</pre>` : ""}
            </div>
          `;
        }).join("");
      } else {
        flagsContainer.innerHTML = `<div style="color: #cccccc; padding: 15px; text-align: center; font-size: 0.9em;">No forensic flags detected. File appears clean.</div>`;
      }

      if (json.errors && Object.keys(json.errors).length > 0) {
        document.getElementById("errorsSection").style.display = "block";
        document.getElementById("errorsMeta").textContent = JSON.stringify(json.errors, null, 2);
      } else {
        document.getElementById("errorsSection").style.display = "none";
      }

      document.getElementById("rawMeta").textContent = JSON.stringify(json, null, 2);
    }

    function showError(message) {
      errorDisplay.classList.add("show");
      const textEl = document.getElementById("errorText");
      textEl.textContent = message;

      // If this looks like a backend connectivity error, give actionable steps
      if (message && message.toLowerCase().includes('cannot reach backend')) {
        textEl.textContent += '\n\nTroubleshooting steps:\n- Ensure backend is running (check terminal).\n- Confirm backend host/port (default: http://127.0.0.1:8000).\n- If running, check firewall or antivirus blocking.\n- Open developer console (F12) -> Network tab for fetch errors.';
        const bs = document.getElementById('backendStatus');
        if (bs) { bs.textContent = 'Backend: unreachable'; bs.style.color = '#cc6666'; }
      }
    }

    document.getElementById("downloadReport").addEventListener("click", () => {
      if (!currentAnalysisData) return;
      const blob = new Blob([JSON.stringify(currentAnalysisData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `metadata-report-${currentAnalysisData.filename || "unknown"}-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>

</body>
</html>

